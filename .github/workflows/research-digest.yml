name: Daily Research Digest

# Runs daily at 7AM UTC. Can also be triggered manually.
on:
  schedule:
    - cron: '0 7 * * *'
  workflow_dispatch:   # lets you trigger from GitHub UI anytime

jobs:
  research:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # needed to commit digest back to repo

    steps:
      - uses: actions/checkout@v4

      - name: Install Claude CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Run researcher agent
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          DATE=$(date +%Y-%m-%d)
          OUTPUT="digests/$DATE.md"
          mkdir -p digests

          claude -p \
            "You are the researcher agent. Today's date is $DATE.
            Research the top trends in agentic workflows and vibe coding.
            Save your digest to: $OUTPUT
            Follow the format and quality bar defined in .claude/agents/researcher.md" \
            --allowedTools "WebSearch,WebFetch,Write" \
            --output-format text

      - name: Generate RSS feed
        run: bash scripts/generate-rss.sh

      - name: Commit digest and feed
        run: |
          DATE=$(date +%Y-%m-%d)
          git config user.name "researcher-agent"
          git config user.email "noreply@github.com"
          git add digests/
          git diff --staged --quiet || git commit -m "digest: researcher digest for $DATE"
          git push

      - name: Send TL;DR preview to Telegram
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          DATE=$(date +%Y-%m-%d)
          FILE="digests/$DATE.md"

          TLDR=$(awk '/^## TL;DR/{found=1; next} found && /^---/{exit} found && /^-/{print}' "$FILE" \
            | sed 's/^- /â€¢ /' | head -5)

          TEXT="ðŸ“‹ *Daily Digest â€” ${DATE}*

${TLDR:-No TL;DR found.}

_Full digest attached â†“_"

          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            --data-urlencode "chat_id=${CHAT_ID}" \
            --data-urlencode "text=${TEXT}" \
            -d "parse_mode=Markdown"

      - name: Send full digest as document
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          DATE=$(date +%Y-%m-%d)
          FILE="digests/$DATE.md"
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
            -F "chat_id=${CHAT_ID}" \
            -F "document=@${FILE};filename=digest-${DATE}.md" \
            -F "caption=ðŸ¤– Full digest for ${DATE}"
