name: Deliver Digest to Telegram

# Triggers when the researcher agent pushes a new daily digest
on:
  push:
    paths:
      - 'digests/[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9].md'

jobs:
  deliver:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2  # need parent commit to diff

      - name: Find new digest file
        id: digest
        run: |
          FILE=$(git diff --name-only HEAD^ HEAD | grep -E 'digests/[0-9]{4}-[0-9]{2}-[0-9]{2}\.md' | head -1)
          if [[ -z "$FILE" ]]; then
            echo "No new digest file found in this push."
            exit 1
          fi
          DATE=$(basename "$FILE" .md)
          echo "file=$FILE" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "Found digest: $FILE"

      - name: Extract TL;DR
        id: tldr
        run: |
          FILE="${{ steps.digest.outputs.file }}"
          # Extract bullet points from TL;DR section
          TLDR=$(awk '/^## TL;DR/{found=1; next} found && /^---/{exit} found && /^-/{print}' "$FILE" \
            | sed 's/^- /â€¢ /' \
            | head -5)
          echo "tldr<<EOF" >> $GITHUB_OUTPUT
          echo "$TLDR" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send TL;DR preview to Telegram
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          DATE="${{ steps.digest.outputs.date }}"
          TLDR="${{ steps.tldr.outputs.tldr }}"
          TEXT="ðŸ“‹ *Daily Digest â€” ${DATE}*

${TLDR:-No TL;DR found.}

_Full digest attached â†“_"
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            --data-urlencode "chat_id=${CHAT_ID}" \
            --data-urlencode "text=${TEXT}" \
            -d "parse_mode=Markdown"

      - name: Send full digest as document
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          FILE="${{ steps.digest.outputs.file }}"
          DATE="${{ steps.digest.outputs.date }}"
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
            -F "chat_id=${CHAT_ID}" \
            -F "document=@${FILE};filename=digest-${DATE}.md" \
            -F "caption=ðŸ¤– Full digest for ${DATE}"
